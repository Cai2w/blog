---
title: éŸ³é¢‘æ—¶é•¿è§£æå·¥å…·
date: 2021-09-04 00:32:02
tags:
- éŸ³é¢‘æ—¶é•¿è§£æ
categories:
- [Java,JavaUtils]
description: è·å–éŸ³é¢‘æ—¶é•¿çš„Javaå·¥å…·ç±»ï¼Œæ”¯æŒæ ¼å¼ï¼šmp3ï¼Œwavï¼›åŒæ—¶åŒ…å«MultipartFileè½¬Fileçš„å·¥å…·ç±»
sticky:
cover: https://cdn.jsdelivr.net/gh/Cai2w/cdn/img/undraw_add_color_19gv.png
---

> æœ€è¿‘åœ¨å…¬å¸åœ¨åšè§†é¢‘æ··å‰ªç›¸å…³çš„ä¸šåŠ¡ï¼Œæˆ‘ä¹Ÿå­¦ä¹ äº†ä¸€äº›ç›¸å…³çš„çŸ¥è¯†ï¼Œè¿™ç¯‡æ–‡ç« å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹è·å–éŸ³é¢‘æ—¶é•¿çš„ç›¸å…³å·¥å…·ç±»

## åŸºäºjaudiotaggerçš„éŸ³é¢‘æ—¶é•¿è§£æ

ä¸ºäº†ä»£ç çš„è§„èŒƒæ€§ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªéŸ³é¢‘ç±»å‹çš„æšä¸¾ç±»ï¼Œç”¨æ¥è¡¨æ˜æˆ‘ä»¬çš„å·¥å…·æ”¯æŒå“ªäº›éŸ³é¢‘ç±»å‹ã€‚

```java
import com.mysql.cj.util.StringUtils;

/**
 * @author caicai
 * @date 2021/8/27 14:08
 */
public enum AudioContentType {
    /**
     * éæ³•ç±»å‹
     */
    ILLEGAL("","", 0),
    MP3("audio/mp3","MP3",1),
    WAV("audio/wav", "WAV",2);
    MP3_OTHER("audio/mpeg","MP3",3),
    WAV_OTHER("audio/wave", "WAV",4);

    private String contentType;
    private String type;
    private int code;

    AudioContentType(String contentType, String type, int code) {
        this.contentType = contentType;
        this.type = type;
        this.code = code;
    }

    public String getContentType() {
        return contentType;
    }

    public int getCode() {
        return code;
    }

    public String getType() {
        return type;
    }

    public static AudioContentType create(String contentType) {
        if (StringUtils.isNullOrEmpty(contentType)) {
            return ILLEGAL;
        }
        for (AudioContentType type : values()) {
            if (type.contentType.equals(contentType)) {
                return type;
            }
        }
        return ILLEGAL;
    }
    public static AudioContentType create(int code) {
        for (AudioContentType type : values()) {
            if (type.code == code) {
                return type;
            }
        }
        return ILLEGAL;
    }

    public static AudioContentType create(Integer code) {
        return create(code.intValue());
    }
}
```

ç„¶åå°±æ˜¯éŸ³é¢‘å·¥å…·ç±»çš„ç¼–å†™äº†

å¼•å…¥ä¾èµ–

```xml
<!-- è·å–éŸ³é¢‘æ—¶é•¿ -->
<!-- https://mvnrepository.com/artifact/org/jaudiotagger -->
<dependency>
    <groupId>org</groupId>
    <artifactId>jaudiotagger</artifactId>
    <version>2.0.3</version>
</dependency>
```

éŸ³é¢‘å·¥å…·ç±»

```java
import com.talkingdata.addct.common.enums.AudioContentType;
import lombok.extern.slf4j.Slf4j;
import org.jaudiotagger.audio.AudioFileIO;
import org.jaudiotagger.audio.mp3.MP3AudioHeader;
import org.jaudiotagger.audio.mp3.MP3File;
import org.springframework.web.multipart.MultipartFile;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;

/**
 * @author caicai
 * @date 2021/8/27 17:36
 */
@Slf4j
public class AudioUtils {

    private static final Long TIME_CONVERSION = 1000L;

    /**
     * è·å–éŸ³é¢‘æ—¶é•¿ æ”¯æŒæ ¼å¼ï¼šmp3  wav
     */
    public static Integer getDuration(File file, AudioContentType contentType) {
        switch (contentType) {
            case MP3:
            case MP3_OTHER:
                return getMp3Duration(file).intValue();
            case WAV:
            case WAV_OTHER:
                return getWavDuration(file).intValue();
            default:
                log.error("ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼,æ— æ³•è·å–éŸ³é¢‘æ—¶é•¿");
                return null;
        }
    }


    /**
     * è·å–è¯­éŸ³æ–‡ä»¶æ’­æ”¾æ—¶é•¿(æ¯«ç§’) æ”¯æŒwav æ ¼å¼
     *
     * @param wavFile
     * @return
     */
    public static Float getWavDuration(File wavFile) {
        BufferedInputStream bufferedInputStream = null;
        AudioInputStream audioInputStream = null;
        try {
            bufferedInputStream = new BufferedInputStream(new FileInputStream(wavFile));
            audioInputStream = AudioSystem.getAudioInputStream(bufferedInputStream);
            AudioFormat format = audioInputStream.getFormat();
            long audioFileLength = wavFile.length();
            int frameSize = format.getFrameSize();
            float frameRate = format.getFrameRate();
            float durationInSeconds = (audioFileLength / (frameSize * frameRate));
            return durationInSeconds * TIME_CONVERSION;
        } catch (Exception e) {
            log.error("éŸ³é¢‘æ—¶é•¿è§£æé”™è¯¯", e);
            return 0f;
        } finally {
            try {
                bufferedInputStream.close();
                audioInputStream.close();
            } catch (IOException e) {
                log.error("å­—èŠ‚æµå…³é—­é”™è¯¯", e);
            }
        }

    }

    /**
     * è·å–mp3è¯­éŸ³æ–‡ä»¶æ’­æ”¾æ—¶é•¿(æ¯«ç§’)
     *
     * @param mp3File
     * @return
     */
    public static Float getMp3Duration(File mp3File) {

        try {
            MP3File f = (MP3File) AudioFileIO.read(mp3File);
            MP3AudioHeader audioHeader = (MP3AudioHeader) f.getAudioHeader();
            return Float.parseFloat(audioHeader.getPreciseTrackLength() + "") * TIME_CONVERSION;
        } catch (Exception e) {
            log.error("éŸ³é¢‘æ—¶é•¿è§£æé”™è¯¯", e);
            return 0f;
        }
    }

    /**
     * è·å–éŸ³é¢‘åç§°
     */
    public static String getAudioName(MultipartFile audio) {
        return audio.getOriginalFilename().split("\\.")[0];
    }
}
```

> æ³¨æ„ï¼š`getWavDuration(File wavFile)`æ–¹æ³•ä¸­`AudioSystem.getAudioInputStream(bufferedInputStream);`éœ€è¦ç”¨ç¼“å†²æµã€‚æˆ‘ä¹‹å‰ç›´æ¥ç”¨çš„fileï¼Œä½†æ˜¯è¿™æ ·å¯¼è‡´æ–‡ä»¶ä¸€ç›´è¢«å ç”¨ï¼Œæ— æ³•è¿›è¡Œåˆ«çš„æ“ä½œã€‚

## åŸºäºffmpegçš„éŸ³é¢‘æ—¶é•¿è§£æ

> `ffmpeg`æ˜¯ä¸€æ¬¾ååˆ†å¼ºå¤§çš„éŸ³è§†é¢‘è§£æå·¥å…·ï¼Œå·´æ‹‰å·´æ‹‰......
>
> ğŸš§æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼š

å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.bytedeco.javacpp-presets</groupId>
    <artifactId>ffmpeg-platform</artifactId>
    <version>4.0.2-1.4.3</version>
</dependency>
```

ç¼–å†™å·¥å…·ç±»

```java
@Slf4j
public class AudioUtils {

    private static final Long TIME_CONVERSION = 1000L;

    /**
     * è·å–éŸ³é¢‘æ—¶é•¿
     */
    public static Long audioDuration(File file) throws Exception {
        Long times = 0L;
        FFmpegFrameGrabber ff = null;
        try {
            ff = new FFmpegFrameGrabber(file);
            ff.start();
            times = ff.getLengthInTime() / TIME_CONVERSION;
        } catch (Exception e) {
            log.error("éŸ³é¢‘æ—¶é•¿è§£æé”™è¯¯", e);
            e.printStackTrace();
        } finally {
            if (ff != null) {
                ff.stop();
            }
        }
        return times;
    }
}
```

> å› ä¸ºffmpegå·¥å…·ååˆ†å¼ºå¤§ï¼ˆåšä¸»æ²¡è§è¿‡ä»€ä¹ˆä¸–é¢ï¼‰ï¼Œ**ä¸Šé¢è¿™ä¸ªå·¥å…·ç±»ä¸ä»…èƒ½è§£æéŸ³é¢‘æ—¶é•¿ï¼Œè¿˜å¯ä»¥è§£æè§†é¢‘çš„æ—¶é•¿**ã€‚ç”±äºåšä¸»ç”µè„‘é‡Œåªæœ‰`.mp3`ã€`.wav`æ ¼å¼çš„éŸ³é¢‘å’Œ`.mp4`æ ¼å¼çš„è§†é¢‘æ‰€ä»¥åªæµ‹è¯•è¿™å‡ ç§æ ¼å¼çš„æ–‡æ¡ˆï¼Œæ—¶é•¿è§£ææ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚å¯ä»¥å¤§èƒ†ä¸Šè½¦ï¼ï¼

---

å› ä¸ºä½¿ç”¨çš„æ˜¯springbootï¼Œæ–‡ä»¶æ¥æ”¶æ˜¯ç”¨çš„MultipartFileï¼Œè€Œæˆ‘ä»¬çš„å·¥å…·ç±»ä¼ å…¥çš„å‚æ•°æ˜¯Fileç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªMultipartFileè½¬Fileçš„å·¥å…·ç±»

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;

/**
 * @author wangpeixu
 * @date 2021/8/31 14:05
 */
@Slf4j
public class MultipartFileToFileUtils {
    /**
     * MultipartFile è½¬ File
     *
     * @param file
     * @throws Exception
     */
    public static File multipartFileToFile(MultipartFile file) throws Exception {

        File toFile = null;
        if (file.equals("") || file.getSize() <= 0) {
            file = null;
        } else {
            InputStream ins = null;
            ins = file.getInputStream();
            toFile = new File(System.currentTimeMillis()+"_"+file.getOriginalFilename());
            inputStreamToFile(ins, toFile);
        }
        return toFile;
    }

    //è·å–æµæ–‡ä»¶
    private static void inputStreamToFile(InputStream ins, File file) {
        try {
            OutputStream os = new FileOutputStream(file);
            int bytesRead = 0;
            byte[] buffer = new byte[8192];
            while ((bytesRead = ins.read(buffer, 0, 8192)) != -1) {
                os.write(buffer, 0, bytesRead);
            }
            os.close();
            ins.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    /**
     * åˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
     * @param file
     */
    public static void delteTempFile(File file) {
        if (file != null) {
            File del = new File(file.toURI());
            boolean result = false;
            int tryCount = 0;
            while(!result && tryCount++ <10)
            {
                log.info("try to delete file "+ del.getName() +" cnt:"+tryCount);
                result = del.delete();
            }
        }
    }
}
```

## æ€»ç»“

ä¸Šè¿°è¿™ä¸¤æ¬¾éŸ³é¢‘æ—¶é•¿è§£æå·¥å…·ï¼Œåšä¸»æ›´é’çåè€…ï¼ˆffmpegï¼‰ï¼ŒçœŸçœŸæ­£æ­£çš„çŸ­å°è€Œç²¾æ‚ã€‚**ä»£ç å°‘ï¼Œæ•ˆæœå¥½ï¼Œè°ä¼šä¸çˆ±å‘¢&#x2B50;**

