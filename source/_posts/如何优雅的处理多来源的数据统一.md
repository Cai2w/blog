---
title: å¦‚ä½•ä¼˜é›…çš„å¤„ç†å¤šæ¥æºçš„æ•°æ®ç»Ÿä¸€
date: 2022-01-09 00:24:31
tags:
- è®¾è®¡æ¨¡å¼
categories:
- [è®¾è®¡æ¨¡å¼,ç»„åˆæ‹³]
description: 
sticky:
cover: https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/undraw_mobile_browsers_lib5.png
---

> æˆ‘æ˜¯èœèœğŸ¥¬ï¼Œä¸€ä¸ªäººèœç˜¾å¤§çš„äº’è”ç½‘ä»ä¸šè€…ğŸ‰
>
> ç”¨åŠŸä¸æ±‚å¤ªçŒ›ï¼Œä½†æ±‚æœ‰æ’ğŸˆ

**çœ‹å®Œæœ¬æ–‡ğŸ“–**

ä½ å°†ï¼š

* æ¸…æ¥šå¤šæ¥æºçš„æ•°æ®å¦‚æœåšåˆ°ç»“æ„ç»Ÿä¸€
* å¯¹æ¨¡æ¿æ–¹æ³•æ¨¡å¼æœ‰æ›´å¤šçš„äº†è§£
* å¯¹ç®€å•å·¥å‚(è™½è¯´ä¸æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§ï¼Œä½†æ˜¯ç”¨çš„è¿˜æ˜¯æŒºå¤šçš„)èƒ½æœ‰æ›´æ·±çš„ç†è§£
* çŸ¥é“è®¾è®¡æ¨¡å¼ä¹‹é—´çš„ç»„åˆä½¿ç”¨

## å‰è¨€

æœ¬æ–‡ä¸»è¦æ˜¯è®°å½•å’Œåˆ†äº«æˆ‘åœ¨åšETLçš„ä¸šåŠ¡æ—¶è§£å†³**å¤šç§ä¸åŒæ¥æºçš„æ•°æ®è¿›è¡Œç»“æ„åŒ–ç»Ÿä¸€**çš„é—®é¢˜ã€‚æœ¬æ–‡æ¶‰åŠäº†23ç§è®¾è®¡æ¨¡å¼ä¸­çš„è´£ä»»é“¾æ¨¡å¼å’Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚å¯¹è¿™ä¸¤ç§æ¨¡å¼ä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„ç›¸å…³æ–‡ç« ï¼š

[ğŸ‘‰æ¨¡æ¿æ–¹æ³•æ¨¡å¼ğŸ‘ˆ](https://blog.cai2.wang/2021/09/22/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/)  [ğŸ‘‰å·¥å‚æ¨¡å¼ğŸ‘ˆ](https://blog.cai2.wang/2021/09/22/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/)

## ä¸šåŠ¡è¯´æ˜

åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæœ‰å„ç§ä¸åŒå¹³å°çš„ç´ ææ•°æ®ï¼Œä½†æ˜¯æ¯ä¸ªå¹³å°çš„ç´ ææ•°æ®å¯èƒ½éƒ½ç¨æœ‰ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ•°æ®å¤„ç†ä¸€ä¸‹ï¼Œæœ€åè¾“å‡ºç»Ÿä¸€çš„æ•°æ®æ ¼å¼ä¾›ä¸‹æ¸¸è¿›è¡Œè®¡ç®—å¤„ç†ï¼›åŒæ—¶ä¹Ÿè¦æœ‰è‰¯å¥½çš„æ‹“å±•æ€§ï¼Œä»¥ä¾›æˆ‘ä»¬åç»­æ‹“å±•ç´ ææ¥æºã€‚

æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾æ¥å¸®åŠ©å¤§å®¶ç†è§£ä¸šåŠ¡åœºæ™¯

![](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/20220109182407.png)

## æ•°æ®æŠ½å–

é¦–å…ˆæ•°æ®æŠ½å–è½¬æ¢çš„ç»“æœæ˜¯è·å¾—ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®ç»“æ„çš„å¯¹è±¡ï¼Œè€Œä¸”æ˜¯å¤šç§æ¥æºã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨**å·¥å‚æ¨¡å¼**æ¥è¿›è¡Œè§£è€¦ã€‚è¿™é‡Œæˆ‘å°±ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼äº†ï¼Œè™½ç„¶å®ƒä¸æ˜¯23ç§è®¾è®¡æ¨¡å¼ä¸­çš„ï¼Œä½†æ˜¯ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ã€‚

ç”±äºè™½ç„¶æ˜¯ä¸åŒæ¥æºçš„æ•°æ®ï¼Œä½†æ˜¯å¤šå¤šå°‘å°‘è¿˜æ˜¯ä¼šæœ‰ä¸€äº›ç›¸åŒçš„å±æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›å…±åŒçš„å±æ€§ç»Ÿä¸€è¿›è¡Œè®¾ç½®ï¼Œä¸åŒçš„å±æ€§å†å•ç‹¬è¿›è¡Œå¤„ç†ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬çš„**æ¨¡æ¿æ–¹æ³•æ¨¡å¼**çš„åº”ç”¨åœºæ™¯ã€‚

å…·ä½“ç±»çš„è®¾è®¡å¦‚ä¸‹ï¼š

![](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/20220109224544.png)

### å‡†å¤‡å·¥ä½œ

å¼•å…¥mavenä¾èµ–ï¼š

```xml
<dependencies>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.22</version>
    </dependency>
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.78</version>
    </dependency>
</dependencies>
```

> æœ¬æ–‡ä¸»è¦ç”¨æ¥è®²è§£ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¥è§£å†³å®é™…ä¸šåŠ¡ï¼Œæ‰€ä»¥å…¶ä»–çš„ä¾èµ–ï¼Œè¯¸å¦‚ï¼š`kafka`ã€`flink`ç­‰éƒ½æ²¡æœ‰å¼•å…¥

### åŠŸèƒ½å®ç°

**MediaEnum**

~~~java
package enums;

import lombok.Getter;

/**
 * @author èœèœ
 * @date 2022/1/9 22:21
 * @description ç´ ææšä¸¾
 */
@Getter
public enum MediaEnum {
    UNKNOWN("æœªçŸ¥", 0,"unknown"),
    FIRST_TRANSFORM("æ¥æºä¸€", 1,"first_transform"),
    SECOND_TRANSFORM("æ¥æºäºŒ", 2,"second_transform"),
    THIRD_TRANSFORM("æ¥æºä¸‰", 3,"third_transform");
    private String name;
    private int code;
    private String alias;

    MediaEnum(String name, int code, String alias) {
        this.name = name;
        this.code = code;
        this.alias = alias;
    }

    public static MediaEnum create(String name) {
        for (MediaEnum media : values()) {
            if (media.name.equals(name)) {
                return media;
            }
        }
        return UNKNOWN;
    }
}
~~~

**KafkaData**

```java
package entity;

import com.alibaba.fastjson.annotation.JSONField;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

/**
 * @author èœèœ
 * @date 2022/1/9 22:00
 * @description kafkaåŸå§‹æ•°æ®
 */
@Data
public class KafkaData {
    /**
     * æ ‡é¢˜
     */
    private String title;

    /**
     * æè¿°
     */
    private String description;

    /**
     * ä½œè€…
     */
    private String author;

    /**
     * åˆ†ç±»
     */
    private List<String> tags;

    /**
     * ç´ ææ¥æº
     * {@link enums.MediaEnum}
     */
    private String mediaName;
    
    /**
     * ç´ æè·¯å¾„
     */
    private String ossPath;

    /**
     * çˆ¬å–æ—¶é—´
     */
    @JSONField(name = "spider_time", format = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime spiderTime;

    /**
     * åŸå§‹å­—æ®µ
     */
    @JSONField(name = "raw_data")
    private Map<String, Object> rawData;

}
```

> `rawData`å±æ€§è®°å½•çš„æ˜¯ç´ æåŸå§‹çš„æ•°æ®ï¼Œè€Œå…¶ä»–å±æ€§å…¶å®éƒ½æ˜¯ä»`rawData`ä¸­æå–å‡ºæ¥çš„ï¼Œåªä¸è¿‡å„ä¸ªæ¥æºçš„æ•°æ®éƒ½æ‹¥æœ‰è¿™äº›å±æ€§ï¼Œæ‰€ä»¥å°†å…¶æå–å‡ºæ¥ã€‚

**Material**

```java
package entity;

import lombok.Data;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @author èœèœ
 * @date 2022/1/9 22:14
 * @description ç»Ÿä¸€ç»“æ„æ•°æ®
 */
@Data
public class Material {
    /**
     * æ ‡é¢˜
     */
    private String title;

    /**
     * æè¿°
     */
    private String description;

    /**
     * ä½œè€…
     */
    private String author;

    /**
     * æ ‡ç­¾
     */
    private List<String> tags;

    /**
     * ç´ ææ¥æº
     * {@link enums.MediaEnum}
     */
    private Integer media;
    
    /**
     * ç´ æè·¯å¾„
     */
    private String ossPath;

    /**
     * çˆ¬å–æ—¶é—´
     */
    private LocalDateTime spiderTime;

    /**
     * md5
     */
    private String md5;

    /**
     * å°é¢å›¾è·¯å¾„
     */
    private String cover;

    /**
     * ç´ ææ—¶é•¿
     */
    private Integer duration;

    /**
     * ç´ æå®½åº¦
     */
    private Integer width;

    /**
     * ç´ æé•¿åº¦
     */
    private Integer height;

    /**
     * ç´ ææ ¼å¼
     */
    private String format;

    /**
     * æ‹“å±•å­—æ®µ
     */
    private Map<String, Object> expand = new HashMap<>();
}
```

**TransformMetaData**

~~~java
package meta;

import entity.KafkaData;
import entity.Material;
import enums.MediaEnum;
import lombok.Data;

/**
 * @author èœèœ
 * @date 2022/1/9 22:32
 * @description è½¬æ¢å…ƒæ•°æ®
 */
@Data
public abstract class TransformMetaData {
    /**
     * è·å–ç»Ÿä¸€æ•°æ®
     */
    public final Material getMaterial(KafkaData source) {
        if (source != null) {
            Material material = new Material();
            material.setTitle(source.getTitle());
            material.setDescription(source.getDescription());
            material.setAuthor(source.getAuthor());
            material.setTags(source.getTags());
            MediaEnum mediaEnum = MediaEnum.create(source.getMediaName());
            material.setMedia(mediaEnum.getCode());
            material.setSpiderTime(source.getSpiderTime());
            material.setOssPath(source.getOssPath());
            //å¡«å……æ•°æ®
            this.fill(source, material);
            return material;
        }
        return null;
    }

    /**
     * å¡«å……æ•°æ®
     */
    public abstract void fill(KafkaData source, Material material);
}

~~~

> è¿™é‡Œå°±ç”¨åˆ°äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå°†ç›¸åŒéƒ¨åˆ†çš„ä»£ç æ”¾åœ¨æŠ½è±¡çš„çˆ¶ç±»çš„`getMaterialBo`æ–¹æ³•ä¸­ï¼Œè€Œå°†ä¸åŒçš„ä»£ç æ”¾å…¥ä¸åŒçš„å­ç±»çš„`fill`æ–¹æ³•ä¸­å®ç°

**FirstTransform**

~~~java
package meta;

import entity.KafkaData;
import entity.Material;

/**
 * @author èœèœ
 * @date 2022/1/9 22:52
 * @description æ¥æºä¸€
 */
public class FirstTransform extends TransformMetaData{
    @Override
    public void fill(KafkaData source, Material material) {

    }
}
~~~
**SecondTransform**
~~~java
package meta;

import entity.KafkaData;
import entity.Material;

/**
 * @author èœèœ
 * @date 2022/1/9 22:52
 * @description æ¥æºäºŒ
 */
public class SecondTransform extends TransformMetaData{
    @Override
    public void fill(KafkaData source, Material material) {

    }
}
~~~

**ThirdTransform**

~~~java
package meta;

import entity.KafkaData;
import entity.Material;

/**
 * @author èœèœ
 * @date 2022/1/9 22:52
 * @description æ¥æºä¸‰
 */
public class ThirdTransform extends TransformMetaData{
    @Override
    public void fill(KafkaData source, Material material) {

    }
}
~~~

**TransformFactory**

~~~java
package meta;

import entity.KafkaData;
import entity.Material;
import enums.MediaEnum;
import lombok.extern.slf4j.Slf4j;

import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.Set;

/**
 * @author èœèœ
 * @date 2022/1/9 22:56
 * @description æ•°æ®è½¬æ¢å·¥å‚
 */
@Slf4j
public class TransformFactory {
    private static Map<String, TransformMetaData> map = new HashMap();

    private final static String PROPERTIES_NAME = "transform.properties";

    /**
     * åˆå§‹åŒ–å·¥å‚ç±»
     */
    static {
        Properties p = new Properties();
        InputStream is = TransformFactory.class.getClassLoader().getResourceAsStream(PROPERTIES_NAME);
        try {
            p.load(is);
            //éå†Propertiesé›†åˆå¯¹è±¡
            Set<Object> keys = p.keySet();
            for (Object key : keys) {
                //æ ¹æ®é”®è·å–å€¼ï¼ˆå…¨ç±»åï¼‰
                String className = p.getProperty((String) key);
                //è·å–å­—èŠ‚ç å¯¹è±¡
                Class clazz = Class.forName(className);
                TransformMetaData obj = (TransformMetaData) clazz.newInstance();
                map.put((String) key, obj);
            }
        } catch (Exception e) {
            log.error("æ•°æ®è½¬æ¢ç±»åŠ è½½å¤±è´¥", e);
            e.printStackTrace();
        }
    }

    /**
     * æ ¹æ®åª’ä½“åç§°è·å–è½¬æ¢åçš„å¯¹è±¡
     *
     * @return
     */
    public static Material getMaterial(KafkaData source) {
        if (source == null || source.getMediaName() == null) {
            log.error("sourceä¸ºç©ºæˆ–sourceä¸­ä¸åŒ…å«ç´ ææ¥æº,data=[{}]", source);
            return null;
        }
        MediaEnum mediaSource = MediaEnum.create(source.getMediaName());
        TransformMetaData transformMetaData = map.get(mediaSource.getAlias());
        if (transformMetaData == null) {
            log.error("æ— æ³•è§£æçš„ç´ ææ¥æº:data=[{}]", source.getMediaName());
            return null;
        }
        return transformMetaData.getMaterial(source);
    }
}
~~~

ç„¶åæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºä¸€ä¸ª`transform.properties`æ–‡ä»¶ç”¨æ¥å·¥å‚ç±»çš„åˆå§‹åŒ–

```properties
first_transform=meta.FirstTransform
second_transform=meta.SecondTransform
third_transform=meta.ThirdTransform
```

**Client**

~~~java
import entity.KafkaData;
import entity.Material;
import meta.TransformFactory;

/**
 * @author èœèœ
 * @date 2022/1/9 23:23
 */
public class Client {
    public static void main(String[] args) {
        //è¿™é‡Œæˆ‘å°±ä¸è®¾ç½®å€¼äº†
        KafkaData kafkaData = new KafkaData();
        Material material = TransformFactory.getMaterial(kafkaData);
        //è¿™é‡Œå¾—åˆ°çš„å°±æ˜¯ç»Ÿä¸€æ ¼å¼ä¹‹åçš„æ•°æ®å•¦
    }
}
~~~

> å¯¹äºä¸åŒæ¥æºçš„ç´ æï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«åœ¨å¯¹åº”çš„`Transform`ç±»ä¸‹çš„`fill`æ–¹æ³•åšå¤„ç†ï¼›åŒæ—¶åæœŸæ‹“å±•çš„æ—¶å€™ä¹Ÿå¾ˆå®¹æ˜“ï¼Œåªéœ€è¦åœ¨`transform.properyties`æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„å¯¹åº”è§„åˆ™ï¼Œpropertiesçš„keyå‘½åå¯ä»¥é€šè¿‡`TransformFactory`ç±»çš„60è¡ŒçŸ¥æ™“ï¼Œå¹¶ä¸”å†æ·»åŠ ç›¸åº”çš„`Transform`ç±»ç»§æ‰¿`TransformMetaData`ç±»å³å¯

